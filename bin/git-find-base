#!/bin/bash
set -e

range=${*:-"@{upstream}.."}

git log --grep '^\(fixup\|squash\)! ' --format="%s" $range \
	| sed -E 's/^(fixup|squash)! //' \
	| while read -r title; do
		git rev-parse --verify --quiet "$title^{commit}" \
			|| git rev-list --grep="$title" --fixed-strings --max-count=2 $range
		done \
	| xargs git merge-base --octopus
